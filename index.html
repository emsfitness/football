<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø§ØªØ´ ÙƒÙˆØ±Ø© Ø¨ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ†</title>
  <style>
    body { font-family: Arial; text-align: center; background: #d0f0ff; margin: 0; padding: 0; }
    .screen { display: none; padding: 20px; }
    .active { display: block; }
    #playersList { margin-top: 10px; }
    .player { background: #fff; padding: 10px; margin: 5px auto; width: 200px; border-radius: 5px; }
    #field {
      width: 80vw; height: 60vh; background: green; margin: 20px auto; position: relative; border: 4px solid #fff;
      background-image: 
        linear-gradient(white 2px, transparent 2px),
        linear-gradient(90deg, white 2px, transparent 2px),
        radial-gradient(circle at 50% 50%, transparent 20%, white 21%, white 22%, transparent 23%);
      background-size: 100% 100%, 100% 100%, 30% 30%;
      background-repeat: no-repeat;
    }
    .ball, .player-icon {
      width: 30px; height: 30px; position: absolute; border-radius: 50%;
      text-align: center; line-height: 30px; font-weight: bold; color: white;
    }
    .ball { background: orange; transform: translate(-50%, -50%); }
    .player-icon { background: blue; }
    .goal { 
      position: absolute; 
      width: 10%; 
      height: 20%; 
      opacity: 0.5; 
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .goal.left { left: 0; top: 40%; background: red; }
    .goal.right { right: 0; top: 40%; background: blue; }
    #scoreBoard { font-size: 20px; margin: 10px; }
    #timer { font-size: 18px; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    #messageArea { margin-top: 20px; font-size: 18px; color: red; display: none; }
  </style>
</head>
<body>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginScreen" class="screen active">
    <h2>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</h2>
    <input type="text" id="playerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
    <button onclick="joinGame()">Ø§Ù†Ø¶Ù…</button>
  </div>

  <!-- ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
  <div id="waitingRoom" class="screen">
    <h2>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
    <div id="playersList"></div>
    <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</button>
  </div>

  <!-- Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© -->
  <div id="gameField" class="screen">
    <h2>ğŸŸï¸ Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</h2>
    <div id="scoreBoard">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="scoreA">0</span> - <span id="scoreB">0</span></div>
    <div id="timer">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="timeLeft">10:00</span></div>
    <div id="field">
      <div class="goal left" id="leftGoal">Ù…Ø±Ù…Ù‰ A</div>
      <div class="goal right" id="rightGoal">Ù…Ø±Ù…Ù‰ B</div>
      <div class="ball" id="ball">âš½</div>
    </div>
    <button onclick="resetGame()">ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</button>
    <div id="messageArea"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDUFdNboswpWIs0I5ry4aJs3aXHlg1CKkM",
      authDomain: "match-9d433.firebaseapp.com",
      projectId: "match-9d433",
      storageBucket: "match-9d433.appspot.com",
      messagingSenderId: "1050352234947",
      appId: "1:1050352234947:web:74aa21731ea3b94637cd76",
      measurementId: "G-59QRBNR1WQ",
      databaseURL: "https://match-9d433-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const matchId = new URLSearchParams(location.search).get("match") || "defaultMatch";
    const playersRef = db.ref(`${matchId}/players`);
    const gameStartedRef = db.ref(`${matchId}/gameStarted`);
    const scoreRef = db.ref(`${matchId}/score`);
    const ballRef = db.ref(`${matchId}/ball`);
    const ballVelocityRef = db.ref(`${matchId}/ballVelocity`);
    const timeRef = db.ref(`${matchId}/time`);

    let currentPlayer = "";
    let isHost = false;
    let timerInterval;
    let gameDuration = 600;
    let gameStarted = false;
    let playerNames = [];

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showMessage(msg, duration = 2000) {
      const area = document.getElementById("messageArea");
      area.textContent = msg;
      area.style.display = "block";
      setTimeout(() => {
        area.style.display = "none";
      }, duration);
    }

    function joinGame() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ!");

      currentPlayer = name;
      const playerRef = playersRef.child(name);

      playerRef.set({
        name: name,
        x: 50,
        y: 50,
        joinedAt: Date.now()
      });

      playersRef.once("value").then(snapshot => {
        const players = snapshot.val();
        playerNames = Object.keys(players || {});
        if (playerNames.length === 1 || playerNames[0] === name) isHost = true;
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø±Ù…ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
        if (playerNames.length > 0) {
          document.getElementById("leftGoal").textContent = `Ù…Ø±Ù…Ù‰ ${playerNames[0]}`;
        }
        if (playerNames.length > 1) {
          document.getElementById("rightGoal").textContent = `Ù…Ø±Ù…Ù‰ ${playerNames[1]}`;
        }
      });

      gameStartedRef.once("value").then(snap => {
        if (snap.val()) {
          alert("Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¢Ù†.");
          return;
        } else {
          showScreen("waitingRoom");
        }
      });
    }

    function updateWaitingRoom(players) {
      const list = document.getElementById("playersList");
      list.innerHTML = "";
      Object.values(players).forEach(p => {
        const div = document.createElement("div");
        div.className = "player";
        div.textContent = p.name;
        list.appendChild(div);
      });
    }

    function startGame() {
      if (!isHost) return alert("ÙÙ‚Ø· Ù…Ù† Ø¨Ø¯Ø£ Ø§Ù„ØºØ±ÙØ© ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©!");
      db.ref(matchId).update({
        gameStarted: true,
        ball: { x: 50, y: 50 },
        ballVelocity: { x: 0, y: 0 },
        score: { A: 0, B: 0 },
        time: gameDuration
      });
    }

    function updateTimer(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      document.getElementById("timeLeft").textContent = `${m}:${s}`;
    }

    function startCountdown() {
      timerInterval = setInterval(() => {
        timeRef.once("value").then(snap => {
          let t = snap.val();
          if (t <= 0) {
            clearInterval(timerInterval);
            showMessage("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©!");
            return;
          }
          timeRef.set(t - 1);
        });
      }, 1000);
    }

    function renderPlayers(players) {
      const field = document.getElementById("field");
      field.querySelectorAll(".player-icon").forEach(p => p.remove());
      Object.values(players).forEach((p) => {
        const el = document.createElement("div");
        el.className = "player-icon";
        el.textContent = p.name.charAt(0); // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
        el.title = p.name; // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø¤Ø´Ø±
        el.style.left = p.x + "%";
        el.style.top = p.y + "%";
        field.appendChild(el);
      });
    }

    function renderBall(ball) {
      const el = document.getElementById("ball");
      el.style.left = ball.x + "%";
      el.style.top = ball.y + "%";

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
      if (ball.x < 5 && ball.y > 40 && ball.y < 60) {
        scoreRef.child("B").transaction(v => (v || 0) + 1);
        showMessage(`Ù‡Ø¯Ù Ù„Ù€ ${playerNames[1] || 'Ø§Ù„ÙØ±ÙŠÙ‚ B'}`);
        resetPositions();
      }
      if (ball.x > 95 && ball.y > 40 && ball.y < 60) {
        scoreRef.child("A").transaction(v => (v || 0) + 1);
        showMessage(`Ù‡Ø¯Ù Ù„Ù€ ${playerNames[0] || 'Ø§Ù„ÙØ±ÙŠÙ‚ A'}`);
        resetPositions();
      }
    }

    function updateBallPosition() {
      ballRef.once("value").then(ballSnap => {
        ballVelocityRef.once("value").then(velocitySnap => {
          const ball = ballSnap.val();
          const velocity = velocitySnap.val() || { x: 0, y: 0 };
          
          if (!ball) return;

          // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ø±Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Ø©
          let newX = ball.x + velocity.x;
          let newY = ball.y + velocity.y;

          // Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ù‚Ù„
          if (newX < 0) newX = 0;
          if (newX > 100) newX = 100;
          if (newY < 0) newY = 0;
          if (newY > 100) newY = 100;

          // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø­ØªÙƒØ§Ùƒ (ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹)
          const friction = 0.98;
          const newVelocity = {
            x: Math.abs(velocity.x) > 0.1 ? velocity.x * friction : 0,
            y: Math.abs(velocity.y) > 0.1 ? velocity.y * friction : 0
          };

          // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒØ±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø©
          ballRef.set({ x: newX, y: newY });
          ballVelocityRef.set(newVelocity);
        });
      });
    }

    function resetPositions() {
      playersRef.once("value").then(snap => {
        const updates = {};
        Object.keys(snap.val() || {}).forEach(name => {
          updates[`${matchId}/players/${name}/x`] = 50;
          updates[`${matchId}/players/${name}/y`] = 50;
        });
        updates[`${matchId}/ball`] = { x: 50, y: 50 };
        updates[`${matchId}/ballVelocity`] = { x: 0, y: 0 };
        db.ref().update(updates);
      });
    }

    function renderScore(score) {
      document.getElementById("scoreA").textContent = score.A || 0;
      document.getElementById("scoreB").textContent = score.B || 0;
    }

    function resetGame() {
      db.ref(matchId).set({});
      location.reload();
    }

    function startBallPhysics() {
      setInterval(updateBallPosition, 50);
    }

    playersRef.on("value", snapshot => {
      const players = snapshot.val() || {};
      updateWaitingRoom(players);
      renderPlayers(players);
      
      // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø±Ù…Ù‰
      const names = Object.keys(players);
      if (names.length > 0) {
        document.getElementById("leftGoal").textContent = `Ù…Ø±Ù…Ù‰ ${names[0]}`;
      }
      if (names.length > 1) {
        document.getElementById("rightGoal").textContent = `Ù…Ø±Ù…Ù‰ ${names[1]}`;
      }
      playerNames = names;
    });

    gameStartedRef.on("value", snapshot => {
      gameStarted = snapshot.val();
      if (gameStarted) {
        showScreen("gameField");
        startCountdown();
        startBallPhysics();
      }
    });

    ballRef.on("value", snapshot => {
      const ball = snapshot.val();
      if (ball) renderBall(ball);
    });

    ballVelocityRef.on("value", snapshot => {
      // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¹Ø±Ø¶ Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒØ±Ø©
    });

    scoreRef.on("value", snapshot => {
      const score = snapshot.val() || { A: 0, B: 0 };
      renderScore(score);
    });

    timeRef.on("value", snapshot => {
      updateTimer(snapshot.val() || 0);
    });

    document.addEventListener("keydown", (e) => {
      if (!currentPlayer || !gameStarted) return;
      const allowed = ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"];
      if (!allowed.includes(e.key)) return;

      const playerRef = playersRef.child(currentPlayer);
      playerRef.once("value").then((snap) => {
        let data = snap.val();
        if (!data) return;

        let x = data.x;
        let y = data.y;
        const step = 2;

        if (e.key === "ArrowUp") y = Math.max(0, y - step);
        if (e.key === "ArrowDown") y = Math.min(100, y + step);
        if (e.key === "ArrowLeft") x = Math.max(0, x - step);
        if (e.key === "ArrowRight") x = Math.min(100, x + step);

        playerRef.update({ x, y });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØµØ·Ø¯Ø§Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ù„ÙƒØ±Ø©
        ballRef.once("value").then(bSnap => {
          const ball = bSnap.val();
          if (!ball) return;

          const dx = ball.x - x;
          const dy = ball.y - y;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < 5) {
            // Ø­Ø³Ø§Ø¨ Ø³Ø±Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙƒØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§ØªØ¬Ø§Ù‡ Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
            let velocityX = 0;
            let velocityY = 0;
            
            if (e.key === "ArrowUp") velocityY = -3;
            if (e.key === "ArrowDown") velocityY = 3;
            if (e.key === "ArrowLeft") velocityX = -3;
            if (e.key === "ArrowRight") velocityX = 3;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØªØ­Ø±Ùƒ Ù‚Ø·Ø±ÙŠØ§Ù‹ØŒ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
            if (Math.abs(velocityX) > 0 && Math.abs(velocityY) > 0) {
              velocityX *= 0.7;
              velocityY *= 0.7;
            }

            ballVelocityRef.set({ x: velocityX, y: velocityY });
          }
        });
      });
    });
  </script>
</body>
</html>
